# 🚀 Case Management System - Claude 協作筆記

## 📋 專案概述
NGO 慈善機構管理系統，主要功能包括個案管理、物資管理、活動管理等。

## 🔄 三級權限審核系統實作計畫

### 🎯 核心需求
實作三級權限系統來改善物資審核流程：
- **staff（員工）**：批准/拒絕申請、確認訂單
- **supervisor（主管）**：審核員工確認的訂單，決定是否發放
- **admin（管理員）**：最高權限，可直接審核所有申請

### 📊 新的物資分發流程
```
原流程：申請 → 員工批准 → 員工確認訂單 → 直接發送物資
新流程：申請 → 員工批准 → 員工確認訂單 → 主管審核 → 發送物資
```

#### 詳細狀態轉換
1. **申請提交** → `pending` (待審核)
2. **員工批准** → `approved` (已批准，待發放)
3. **員工確認訂單** → `pending_super_approval` (等待主管審核)
4. **主管批准** → `collected` (已領取)
5. **主管拒絕** → `rejected` (不批准)

### 🔧 技術實作要點

#### 後端修改
1. **Worker 模型**：新增 `Role` 欄位 (staff/supervisor/admin)
2. **API 端點**：
   - `POST /api/RegularSuppliesNeed/{id}/collect` - 確認訂單（狀態→等待主管審核）
   - `GET /api/RegularSuppliesNeed/pending-supervisor-approval` - 取得待審核申請
   - `POST /api/RegularSuppliesNeed/{id}/supervisor-approve` - 主管批准
   - `POST /api/RegularSuppliesNeed/{id}/supervisor-reject` - 主管拒絕

#### 前端修改
1. **權限控制**：
   - 員工：可批准申請、確認訂單
   - 主管：只能看到「主管審核」標籤
   - 管理員：只能看到「管理員審核」標籤
2. **新增組件**：
   - `SupervisorApprovalTab` - 主管審核頁面
   - `AdminApprovalTab` - 管理員審核頁面
3. **狀態處理**：更新所有組件的狀態顯示邏輯

#### 資料庫考量
- `Status` 欄位長度限制：20 字符
- 狀態名稱：`pending_super_approval` (20字符，符合限制)

### 🐛 第一輪實作遇到的問題

#### 主要問題
1. **API 500 錯誤**：狀態字串過長導致資料庫約束違反
2. **權限控制邏輯**：初始實作時權限分配不正確
3. **重複分發問題**：已批准的申請會重複被選取

#### 解決方案記錄
1. **狀態名稱縮短**：`pending_supervisor_approval` → `pending_super_approval`
2. **權限重新分配**：
   - 員工負責日常審核
   - 主管負責最終發放決定
   - 管理員擁有最高權限
3. **分發邏輯修正**：只選取 `approved` 狀態的申請進行分配

### 🎯 第二輪實作策略

#### 實作順序
1. **後端 Worker 模型修改**
2. **後端 API 端點實作**
3. **前端權限服務更新**
4. **前端組件實作**
5. **整合測試**

#### 關鍵檢查點
- [ ] 資料庫字串長度限制
- [ ] API 路由正確性
- [ ] 權限控制邏輯
- [ ] 狀態轉換完整性
- [ ] 前後端資料一致性

### 💡 經驗教訓

#### 技術層面
1. **資料庫約束**：先確認欄位限制再設計狀態名稱
2. **API 測試**：實作後立即測試，不要批量修改
3. **權限設計**：明確定義每個角色的職責範圍
4. **錯誤處理**：添加詳細的日誌以便調試

#### 專案管理
1. **分階段實作**：不要一次性修改太多地方
2. **測試驅動**：每個階段都要有明確的測試標準
3. **文檔記錄**：記錄所有的決策和修改原因

### 🌟 Git 分支管理

#### 分支結構
- **main**: 穩定版本，保持在 "SuppliesUpdate for Emergency" 狀態
- **three-tier-approval-system**: 保存三級權限系統的實作進度
- **supplies-enhancement**: 物資系統增強功能

#### 當前狀態
- main 分支已重置到 "SuppliesUpdate for Emergency" 提交
- 三級權限系統實作已保存在 `three-tier-approval-system` 分支
- 準備開始第二輪實作

---

## 🤝 與 Claude 的協作模式

### 有效的協作方式
1. **明確需求**：提供完整的功能描述和流程說明
2. **分步驟進行**：不要一次性要求太多修改
3. **即時反饋**：遇到問題立即分享錯誤信息
4. **截圖輔助**：提供實際的錯誤截圖幫助診斷

### 推薦的開發流程
1. **需求分析** → **技術設計** → **分階段實作** → **測試驗證** → **部署上線**
2. 每個階段都要有明確的交付物和驗收標準

---

*「革命尚未結束，弟兄們！」- 準備第二輪攻勢 🔥*

最後更新：2025年1月16日